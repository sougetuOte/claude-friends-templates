# t-wada式TDD厳密適用ガイド

## 基本原則：テスト駆動開発の黄金律

> 「失敗するテストを書かずに、プロダクションコードを書いてはならない」

## Red-Green-Refactorサイクル

### 🔴 Red Phase（失敗するテストを書く）
1. **実装前に必ずテストを書く**
2. **テストは必ず失敗することを確認**
3. **失敗理由が期待通りであることを確認**

### 🟢 Green Phase（テストを通す）
1. **最小限の実装でテストを通す**
2. **仮実装（ベタ書き）でもOK**
3. **すべてのテストが通ることを確認**

### 🔵 Refactor Phase（リファクタリング）
1. **テストが通る状態を維持**
2. **コードの品質を向上**
3. **小さなステップで進める**

## TDD実践チェックリスト

### タスク開始前
- [ ] 要件を理解している
- [ ] テスト環境が準備されている
- [ ] テストファイルの配置場所が決まっている

### Red Phase
- [ ] プロダクションコードを一切書いていない
- [ ] テストファイルを作成した
- [ ] 失敗するテストを書いた
- [ ] テストが期待通りに失敗することを確認した
- [ ] エラーメッセージが適切である

### Green Phase
- [ ] 最小限の実装でテストを通した
- [ ] 仮実装から始めた（必要に応じて）
- [ ] すべての既存テストも通っている
- [ ] 不要な実装を追加していない

### Refactor Phase
- [ ] テストが通り続けている
- [ ] コードの重複を除去した
- [ ] 命名を改善した
- [ ] 複雑度を下げた
- [ ] ドキュメントを更新した（必要に応じて）

## 小さなステップの実践

### 1つのテストサイクルの目安
- **15分以内**で完了できる単位
- 1つの振る舞いのみをテスト
- 明確な成功/失敗が判定できる

### TODOリストの活用
```markdown
## 現在のタスク: ユーザー認証機能
- [ ] 空のメールアドレスを拒否する
- [ ] 無効なメールフォーマットを拒否する
- [ ] 正しいメールアドレスを受け入れる
- [ ] パスワードが8文字未満を拒否する
- [ ] パスワードに記号が含まれることを要求する
```

## 三角測量

### 概念
最初のテストでは仮実装（ハードコード）でも良いが、2つ目、3つ目のテストで一般化する。

### 例
```python
# 1つ目のテスト（仮実装でOK）
def test_add_2_and_3():
    assert add(2, 3) == 5

def add(a, b):
    return 5  # 仮実装

# 2つ目のテスト（一般化が必要）
def test_add_1_and_2():
    assert add(1, 2) == 3

def add(a, b):
    return a + b  # 一般化
```

## タスク生成時のTDD確認事項

### 各タスクに含めるべき項目
1. **テストファイルの場所**
   ```
   - [ ] Task: ユーザー認証機能の実装
     - テストファイル: `tests/test_auth.py`
     - 実装ファイル: `src/auth.py`
     - _TDD適用: 必須（Red-Green-Refactor）_
   ```

2. **テストケースの明示**
   ```
   - [ ] Task: メール検証
     - Red: `test_empty_email_rejected()`を書く
     - Green: 最小実装で通す
     - Refactor: エラーメッセージを改善
   ```

3. **カバレッジ目標**
   ```
   - [ ] Task: APIエンドポイント
     - カバレッジ目標: 90%以上
     - エッジケース: 必須
   ```

## 違反パターンと対処法

### ❌ よくある違反
1. **テストなしで実装を始める**
   - 対処: 即座に中断し、テストから書き直す

2. **大きすぎるステップ**
   - 対処: タスクを分解し、より小さな単位に

3. **リファクタリングのスキップ**
   - 対処: Greenの後は必ずリファクタリングを検討

### ✅ 良い実践
1. **コミットの頻度**
   - Red後にコミット
   - Green後にコミット
   - Refactor後にコミット

2. **ペアプログラミング/モブプログラミング**
   - ナビゲーターがTDD遵守を監視
   - ドライバーが実装に集中

## Phase終了時のTDDレビュー項目

### 定量的チェック
- [ ] すべてのプロダクションコードにテストが存在する
- [ ] テストカバレッジが目標値を達成している
- [ ] テストの実行時間が妥当である

### 定性的チェック
- [ ] テストが仕様を明確に表現している
- [ ] テストが独立して実行可能である
- [ ] テストのメンテナンスが容易である

## 参考資料
- [テスト駆動開発](https://www.amazon.co.jp/dp/4274217884) - Kent Beck著、和田卓人訳
- [t-wada/tdd-bc](https://github.com/t-wada/tdd-bc) - TDDブートキャンプ資料
- [実践テスト駆動開発](https://gihyo.jp/book/2012/978-4-7741-5024-0) - 和田卓人監訳

---
*「テストがないコードはレガシーコードだ」- Michael Feathers*