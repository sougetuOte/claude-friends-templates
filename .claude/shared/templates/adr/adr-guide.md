# ADR（Architecture Decision Record）ガイド

## ADRとは
ADRは、プロジェクトにおける重要な技術的決定を記録するドキュメントです。
なぜその決定をしたのか、どのような選択肢があったのか、その影響は何かを明確に記録します。

## いつADRを作成するか

### 作成すべき場合 ✅
- **技術スタックの選択**: 新しいフレームワーク、ライブラリ、ツールの採用
- **アーキテクチャの変更**: システム構造の大きな変更
- **セキュリティポリシー**: 認証方式、暗号化方法の決定
- **パフォーマンス最適化**: キャッシュ戦略、データベース設計の変更
- **開発プロセスの変更**: CI/CD、テスト戦略の大きな変更
- **統合方法の決定**: 外部サービスとの連携方法

### 作成不要な場合 ❌
- 日常的なバグ修正
- 小さなリファクタリング
- ドキュメントの更新
- 既存パターンに従った実装
- 一時的な回避策

## ADR作成のタイミング

### Plannerの場合
1. **設計フェーズ**: 新機能の設計時に技術選択が必要な場合
2. **問題発生時**: 既存の決定が問題を引き起こしている場合
3. **定期レビュー**: 四半期ごとの技術スタックレビュー

### Builderの場合
1. **実装中の発見**: 設計通りに実装できない技術的制約を発見
2. **パフォーマンス問題**: 実装後に重大な性能問題を発見
3. **セキュリティ懸念**: 実装中にセキュリティリスクを発見

## ADR作成フロー

```mermaid
graph TD
    A[技術的決定が必要] --> B{重要な決定か？}
    B -->|Yes| C[ADR作成開始]
    B -->|No| D[通常の実装継続]
    C --> E[/adr:create コマンド実行]
    E --> F[コンテキスト記述]
    F --> G[選択肢の評価]
    G --> H[決定と理由]
    H --> I[影響分析]
    I --> J[実装計画作成]
    J --> K[レビュー依頼]
    K --> L{承認？}
    L -->|Yes| M[Status: Accepted]
    L -->|No| N[修正して再提出]
```

## 良いADRの書き方

### 1. 明確なコンテキスト
```markdown
## Context and Background
現在、ユーザー認証はセッションベースで実装されているが、
マイクロサービス化に伴い、サービス間の認証が複雑になっている。
スケーラビリティとセキュリティの観点から、認証方式の見直しが必要。
```

### 2. 具体的な選択肢
```markdown
### Option 1: JWT (JSON Web Tokens)
- **Overview**: ステートレスなトークンベース認証
- **Pros**:
  - スケーラブル（サーバー側でセッション管理不要）
  - マイクロサービス間で共有しやすい
- **Cons**:
  - トークンの無効化が困難
  - トークンサイズが大きい
```

### 3. 明確な決定理由
```markdown
## Decision
**Choice**: JWT with Refresh Token

**Reasons**:
- マイクロサービスアーキテクチャとの親和性が高い
- 既存の認証基盤からの移行が段階的に可能
- 業界標準で、多くのライブラリがサポート
```

### 4. 実装可能な計画
```markdown
### Phase 1: Preparation (1週間)
- [ ] JWT ライブラリの選定とPOC
- [ ] 既存認証システムとの互換性確認
- [ ] セキュリティレビュー

### Phase 2: Implementation (2週間)
- [ ] 認証サービスの実装（TDD）
- [ ] 既存サービスへの段階的統合
- [ ] 監視とログの実装
```

## ADRのライフサイクル

### 1. Proposed（提案中）
- 初期作成時のステータス
- レビューと議論が必要
- 必要に応じて修正

### 2. Accepted（承認済み）
- 決定が承認され、実装可能
- 実装計画に従って進行
- 定期的なレビュー対象

### 3. Deprecated（非推奨）
- より良い決定に置き換えられた
- 新しいADRへの参照を明記
- 歴史的記録として保持

### 4. Superseded（置き換え済み）
- 完全に新しい決定に置き換えられた
- 後継のADRを明確に指定
- なぜ置き換えられたかを記録

## テンプレートの活用

### 基本テンプレート
`.claude/shared/templates/adr/adr-template.md`を使用

### カスタマイズ
プロジェクトの特性に応じて、以下のセクションを追加：
- コンプライアンス要件
- コスト分析
- 移行計画
- トレーニング要件

## ADRとDesign Syncの連携

1. **ADR作成時**: Design Syncで設計への影響を確認
2. **実装中**: ADRの決定が設計と一致しているか確認
3. **完了後**: 実装結果をADRにフィードバック

## ベストプラクティス

### Do's ✅
- 決定の「なぜ」を明確に記述
- 将来の自分が理解できるように書く
- 具体的な数値や事実を含める
- 実装の成功指標を定義
- 定期的にレビューする

### Don'ts ❌
- 実装の詳細を書きすぎない
- 個人的な好みで決定しない
- 選択肢を十分に検討しない
- レビューなしで承認しない
- 古いADRを更新せずに放置しない

## 参考リンク
- [Documenting Architecture Decisions](https://cognitect.com/blog/2011/11/15/documenting-architecture-decisions) - Michael Nygard
- [ADR GitHub Organization](https://adr.github.io/)
- プロジェクト内のADR: `docs/adr/`

---
*良い決定は良い記録から。未来の自分と仲間のために、明確なADRを残そう。*
