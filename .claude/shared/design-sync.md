# Design Sync（設計同期）メカニズム

## 概要
このドキュメントは、設計と実装の同期を確実に行うためのメカニズムを定義します。
claude-kiro-templateの優れた設計同期アプローチを、claude-friends-templatesのマルチエージェントシステムに適応させています。

## 基本原則

### 設計と実装の即時同期
- **設計変更は即座に文書化**: 実装中に設計の不備や改善点を発見したら、即座に記録
- **実装は設計に忠実に**: 設計から逸脱する場合は必ず理由を記録
- **双方向の同期**: 設計→実装だけでなく、実装→設計のフィードバックも重要

### エージェント間の役割分担
- **Planner**: 設計の責任者、設計変更の承認
- **Builder**: 実装の責任者、設計の問題点の発見と報告

## Design Syncプロセス

### 1. 設計確認フェーズ（Builder開始時）
```markdown
## 設計確認チェックリスト
- [ ] 設計ドキュメントが存在する
- [ ] 実装すべき機能が明確
- [ ] インターフェースが定義されている
- [ ] 依存関係が明示されている
- [ ] 非機能要件が明確
```

### 2. 実装中の設計問題検出（強化版）

#### TDD Design Check Phase統合
実装の各TDDサイクルで設計確認を行う：

```markdown
## TDD Design Check（各サイクル実行）
実行タイミング: Green Phase完了後、Refactor Phase前

### 設計確認項目
- [ ] 実装がdesign.mdの仕様に一致している
- [ ] アーキテクチャ違反がない
- [ ] 意図しない副作用がない
- [ ] SOLID原則に準拠している
- [ ] 既存コンポーネントとの整合性

### 設計問題レポート（問題発見時）
問題種別: [設計不備/設計欠陥/実装逸脱/改善提案]
発見日時: YYYY-MM-DD HH:MM
発見者: Builder
TDDフェーズ: [Red/Green/Design Check/Refactor]

### 問題の詳細
[具体的な問題の説明]

### 設計競合分析（kiro-template流）
1. **競合の評価**:
   - 設計の詳細不足？
   - 設計の欠陥？
   - 実装の逸脱？

2. **決定基準**:
   - 設計が不完全 → design.mdに詳細追加
   - 設計に欠陥 → design.mdを改善
   - 実装が逸脱 → 設計に合わせて実装修正

### 影響範囲
- 影響を受けるコンポーネント: [リスト]
- 変更の規模: [小/中/大]
- 必要な更新ドキュメント: [design.md, api.md, etc.]

### 提案する解決策
[Builderからの提案]

**重要**: 設計更新の延期は禁止。即座の同期が必須。
```

### 3. 設計変更の決定（Plannerの責務）
```markdown
## 設計変更決定記録
変更ID: DC-YYYY-MM-DD-001
決定者: Planner
決定日時: YYYY-MM-DD HH:MM

### 変更内容
[承認された変更の詳細]

### 理由
[変更が必要な理由]

### 実装への指示
[Builderへの具体的な指示]
```

### 4. 設計ドキュメントの更新
- 設計変更は必ず元の設計ドキュメントに反映
- 変更履歴をhistory.mdに記録
- ADR（Architecture Decision Record）が必要な場合は作成

## 設計同期チェックポイント

### タスク開始時
- [ ] 設計ドキュメントの最新版を確認
- [ ] 前回からの設計変更を把握
- [ ] 実装計画との整合性を確認

### 実装中（定期的に）
- [ ] 設計からの逸脱がないか確認
- [ ] 新たな設計上の問題がないか確認
- [ ] パフォーマンスや保守性の観点から設計の妥当性を評価

### タスク完了時
- [ ] 実装が設計通りか最終確認
- [ ] 設計の改善点をまとめる
- [ ] 次回の設計への提言を記録

## 設計ドリフトの防止

### 設計ドリフトとは
時間の経過とともに、設計と実装が乖離していく現象

### 防止策
1. **定期的な設計レビュー**: 各Phaseの終了時に必ず実施
2. **実装からのフィードバック**: Builderからの提案を積極的に取り入れる
3. **設計の継続的更新**: 小さな変更も必ず記録

### 検出方法
```markdown
## 設計ドリフトチェック
- [ ] インターフェースの不一致
- [ ] 未文書化の機能追加
- [ ] 設計にない依存関係
- [ ] パフォーマンス特性の乖離
```

## 自動同期支援（将来実装）

### 設計変更の自動検出
- コードとドキュメントの差分分析
- インターフェース変更の自動検出
- 依存関係グラフの自動生成

### 同期提案の自動生成
- 検出された差分から設計更新案を生成
- 影響分析レポートの自動作成
- 変更の優先度提案

## 使用例

### Builder が設計の問題を発見した場合
```markdown
## 設計問題レポート
問題種別: 不備
発見日時: 2025-07-21 14:30
発見者: Builder

### 問題の詳細
認証APIの設計で、リフレッシュトークンの扱いが未定義。
実装時にセキュリティ上の懸念が発生。

### 影響範囲
- 影響を受けるコンポーネント: AuthService, TokenManager
- 変更の規模: 中

### 提案する解決策
1. リフレッシュトークンを別テーブルで管理
2. 有効期限を7日間に設定
3. 1ユーザー1トークンの制限を追加

→ Plannerへエスカレーション
```

### Planner が設計変更を承認した場合
```markdown
## 設計変更決定記録
変更ID: DC-2025-07-21-001
決定者: Planner
決定日時: 2025-07-21 15:00

### 変更内容
リフレッシュトークン管理機能を設計に追加

### 理由
セキュリティ強化とユーザビリティの向上

### 実装への指示
1. refresh_tokensテーブルを作成
2. TokenManagerにリフレッシュ機能を追加
3. 既存の認証フローに統合

→ 設計ドキュメントを更新後、Builderへ引き継ぎ
```

## 関連ドキュメント
- 設計テンプレート: `.claude/shared/templates/design/`
- ADRテンプレート: `.claude/shared/templates/adr/`
- 変更履歴: `.claude/context/history.md`
- エージェント引き継ぎ: `handover.md`

---
*設計と実装の同期は、プロジェクトの成功の鍵。小さな乖離も見逃さない。*
